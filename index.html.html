<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŒì•… êµìœ¡ìš© ë¦¬ë“¬ íŒ¨í„´ ì—ë””í„° (ê³µìœ  ê°€ëŠ¥)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Symbols:wght@400&display=swap');

        body { font-family: 'Arial', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; background-color: #f8f9fa; margin: 0; padding: 20px; }
        .container { background-color: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); max-width: 1200px; width: 95%; font-family: 'Arial', sans-serif; }
        h1 { color: #212529; margin-bottom: 10px; text-align: center; }
        p.subtitle { text-align: center; color: #495057; font-size: 1em; margin-bottom: 25px; font-weight: bold; }

        /* Controls */
        .controls-area { display: flex; justify-content: center; gap: 30px; background: #e9ecef; padding: 20px; border-radius: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .select-group { display: flex; flex-direction: column; align-items: center; }
        .select-group label { font-weight: bold; margin-bottom: 5px; color: #495057; font-size: 0.9em; }
        .select-group select { padding: 8px 20px; border-radius: 5px; border: 1px solid #ced4da; font-size: 1em; cursor: pointer; font-family: 'Arial', sans-serif; }

        /* Rhythm Creation Area */
        .rhythm-creation-area { 
            border: 3px solid #4dabf7; min-height: 160px; background-color: #e7f5ff; border-radius: 8px; 
            display: flex; margin-bottom: 10px; overflow-x: auto; padding: 10px; gap: 8px; align-items: center;
        }

        /* Measure */
        .measure {
            flex: 1; min-width: 280px; border-right: 4px solid #adb5bd; padding: 35px 5px 5px 5px; 
            display: flex; flex-wrap: wrap; align-content: center; align-items: center; gap: 4px;
            position: relative; background-color: #fff; transition: background-color 0.2s; min-height: 80px;
        }
        .measure:last-child { border-right: 6px double #212529; }
        .measure.drag-over { background-color: #d0ebff; border: 2px solid #339af0; }

        /* Measure Info */
        .measure-info { 
            position: absolute; top: 5px; right: 5px; font-size: 0.9em; font-weight: bold; 
            color: #6c757d; pointer-events: none; background: #f1f3f5; padding: 3px 10px;
            border-radius: 15px; font-family: 'Arial', sans-serif;
        }

        /* Selection Area */
        .selection-container { display: flex; flex-direction: column; gap: 15px; margin-top: 10px; width: 100%; }
        .row-group { border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; background-color: #fff; width: 100%; box-sizing: border-box; }
        .row-group h3 { margin: 0 0 10px 0; font-size: 1.1em; color: #333; border-bottom: 2px solid #f8f9fa; padding-bottom: 5px; font-family: 'Arial', sans-serif; }

        /* Horizontal List */
        .horizontal-list { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: flex-start; }

        /* Block Styling */
        .block { 
            height: 60px; border-radius: 6px; display: flex; align-items: center; 
            justify-content: center; font-size: 2.8em; font-weight: normal; cursor: grab; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: #212529; user-select: none;
            background-color: #fff; line-height: 1; padding-bottom: 8px; box-sizing: border-box;
            flex-shrink: 0; 
            font-family: 'Noto Sans Symbols', sans-serif; 
        }
        .block:active { cursor: grabbing; }
        .block.dragging { opacity: 0.4; }
        .block.playing { box-shadow: 0 0 15px 3px #198754; transform: scale(1.05); transition: transform 0.1s, box-shadow 0.1s; }

        /* Visuals */
        .note-block { background-color: #ffe066; border: 1px solid #fcc419; }
        .rest-block { background-color: #f8f9fa !important; border: 2px dashed #adb5bd; color: #495057 !important; }

        /* â˜… Precise Width System â˜… */
        .w4 { width: 200px; background-color: #ff8787; color: white; } 
        .w3 { width: 150px; background-color: #ffa94d; } 
        .w2 { width: 100px; background-color: #ffd43b; } 
        .w1_5 { width: 75px; background-color: #74c0fc; } 
        .w1 { width: 50px; background-color: #63e6be; } 
        .w0_75 { width: 37.5px; background-color: #20c997; color: white; font-size: 2.0em;} 
        .w0_5 { width: 25px; background-color: #339af0; color: white; font-size: 2.0em;} 
        .w0_375 { width: 18.75px; background-color: #5c7cfa; color: white; font-size: 1.8em; } 
        .w0_25 { width: 12.5px; background-color: #845ef7; color: white; font-size: 1.8em; } 

        .status-message { text-align: center; margin: 15px 0; height: 24px; font-weight: bold; color: #e03131; font-size: 1.1em; }

        .controls { margin-top: 20px; display: flex; justify-content: center; gap: 15px; }
        .control-button { background-color: #495057; color: white; padding: 12px 35px; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; transition: 0.2s; font-family: 'Arial', sans-serif; }
        .control-button#playButton { background-color: #198754; }
        .control-button#shareButton { background-color: #339af0; }

        /* Share Link Area */
        .share-link-area {
            background: #e7f5ff; border: 1px solid #339af0; padding: 15px; border-radius: 8px;
            margin-top: 15px; display: none; flex-direction: column; align-items: center;
        }
        .share-link-area.active { display: flex; }
        .share-link-area label { font-weight: bold; margin-bottom: 8px; color: #1c7ed6; }
        .share-link-area input { 
            width: 90%; max-width: 600px; padding: 10px; border: 1px solid #74c0fc; 
            border-radius: 5px; font-size: 0.9em; text-align: center; 
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ë‚˜ë§Œì˜ ë¦¬ë“¬ ì°½ì‘í•˜ê¸°</h1>
        <p class="subtitle">ìŒì•… êµìœ¡ìš© ë¦¬ë“¬ íŒ¨í„´ ì—ë””í„°</p>
        
        <div class="controls-area">
            <div class="select-group">
                <label>ë°•ì</label>
                <select id="timeSignature">
                    <option value="4/4" selected>4/4ë°•ì (4ë°•)</option>
                    <option value="3/4">3/4ë°•ì (3ë°•)</option>
                    <option value="2/4">2/4ë°•ì (2ë°•)</option>
                </select>
            </div>
            
            <div class="select-group">
                <label>ë¹ ë¥´ê¸° (Tempo)</label>
                <select id="tempoSelect">
                    <option value="80" data-label="ì•ˆë‹¨í…Œ (Andante)">ì•ˆë‹¨í…Œ (80)</option>
                    <option value="100" data-label="ì•ˆë‹¨í‹°ë…¸ (Andantino)" selected>ì•ˆë‹¨í‹°ë…¸ (100)</option>
                    <option value="110" data-label="ëª¨ë°ë¼í†  (Moderato)">ëª¨ë°ë¼í†  (110)</option>
                    <option value="130" data-label="ì•Œë ˆê·¸ë ˆí†  (Allegretto)">ì•Œë ˆê·¸ë ˆí†  (130)</option>
                    <option value="150" data-label="ì•Œë ˆê·¸ë¡œ (Allegro)">ì•Œë ˆê·¸ë¡œ (150)</option>
                </select>
            </div>
            
            <div class="select-group">
                <label>ë§ˆë”” ìˆ˜</label>
                <select id="measureCount">
                    <option value="2" selected>2ë§ˆë””</option>
                    <option value="4">4ë§ˆë””</option>
                    <option value="8">8ë§ˆë””</option>
                </select>
            </div>
            <div class="select-group">
                <label>ì•…ê¸°</label>
                <select id="instrument" disabled>
                    <option value="drum" selected>ë“œëŸ¼ (Drum)</option>
                </select>
            </div>
        </div>
        
        <div id="rhythmCreationArea" class="rhythm-creation-area"></div>
        <div id="statusMessage" class="status-message"></div>
        
        <div id="shareLinkArea" class="share-link-area">
            <label>ì•„ë˜ URLì„ ë³µì‚¬í•˜ì—¬ ê³µìœ í•˜ì‹­ì‹œì˜¤. (ìë™ ë³µì‚¬ ì‹¤íŒ¨ ì‹œ ìˆ˜ë™ ë³µì‚¬)</label>
            <input type="text" id="shareLinkInput" readonly>
        </div>
        
        <p class="remove-hint">ğŸ’¡ ë¸”ë¡ì„ ìƒì ë°–ìœ¼ë¡œ ëŒì–´ë‚´ë©´ **ì‚­ì œ**ë©ë‹ˆë‹¤.</p>

        <div class="selection-container">
            
            <div class="row-group">
                <h3>ìŒí‘œ (Notes) - ë“œë˜ê·¸í•˜ì—¬ ë§ˆë””ì— ë„£ìœ¼ì„¸ìš”</h3>
                <div class="horizontal-list" id="noteSelection">
                    <div id="wholeNote" class="block note-block w4" draggable="true" data-type="note" data-duration="4" data-label="ì˜¨ìŒí‘œ">ğ…</div>
                    <div class="block note-block w3" draggable="true" data-type="note" data-duration="3" data-label="ì 2ë¶„ìŒí‘œ">ğ…—ğ…¥.</div>
                    <div class="block note-block w2" draggable="true" data-type="note" data-duration="2" data-label="2ë¶„ìŒí‘œ">ğ…—ğ…¥</div>
                    <div class="block note-block w1_5" draggable="true" data-type="note" data-duration="1.5" data-label="ì 4ë¶„ìŒí‘œ">â™©.</div>
                    <div class="block note-block w1" draggable="true" data-type="note" data-duration="1" data-label="4ë¶„ìŒí‘œ">â™©</div>
                    <div class="block note-block w0_75" draggable="true" data-type="note" data-duration="0.75" data-label="ì 8ë¶„ìŒí‘œ">â™ª.</div>
                    <div class="block note-block w0_5" draggable="true" data-type="note" data-duration="0.5" data-label="8ë¶„ìŒí‘œ">â™ª</div>
                    <div class="block note-block w0_375" draggable="true" data-type="note" data-duration="0.375" data-label="ì 16ë¶„ìŒí‘œ">ğ…˜ğ…¥ğ…¯.</div>
                    <div class="block note-block w0_25" draggable="true" data-type="note" data-duration="0.25" data-label="16ë¶„ìŒí‘œ">ğ…˜ğ…¥ğ…¯</div>
                </div>
            </div>

            <div class="row-group">
                <h3>ì‰¼í‘œ (Rests) - ë“œë˜ê·¸í•˜ì—¬ ë§ˆë””ì— ë„£ìœ¼ì„¸ìš”</h3>
                <div class="horizontal-list" id="restSelection">
                    <div id="wholeRest" class="block rest-block w4" draggable="true" data-type="rest" data-duration="4" data-label="ì˜¨ì‰¼í‘œ">ğ„»</div>
                    <div class="block rest-block w3" draggable="true" data-type="rest" data-duration="3" data-label="ì 2ë¶„ì‰¼í‘œ">ğ„¼.</div>
                    <div class="block rest-block w2" draggable="true" data-type="rest" data-duration="2" data-label="2ë¶„ì‰¼í‘œ">ğ„¼</div>
                    <div class="block rest-block w1_5" draggable="true" data-type="rest" data-duration="1.5" data-label="ì 4ë¶„ì‰¼í‘œ">ğ„½.</div>
                    <div class="block rest-block w1" draggable="true" data-type="rest" data-duration="1" data-label="4ë¶„ì‰¼í‘œ">ğ„½</div>
                    <div class="block rest-block w0_75" draggable="true" data-type="rest" data-duration="0.75" data-label="ì 8ë¶„ì‰¼í‘œ">ğ„¾.</div>
                    <div class="block rest-block w0_5" draggable="true" data-type="rest" data-duration="0.5" data-label="8ë¶„ì‰¼í‘œ">ğ„¾</div>
                    <div class="block rest-block w0_375" draggable="true" data-type="rest" data-duration="0.375" data-label="ì 16ë¶„ì‰¼í‘œ">ğ„¿.</div>
                    <div class="block rest-block w0_25" draggable="true" data-type="rest" data-duration="0.25" data-label="16ë¶„ì‰¼í‘œ">ğ„¿</div>
                </div>
            </div>

        </div>

        <div class="controls">
            <button id="playButton" class="control-button">â–¶ ì¬ìƒ (ë“œëŸ¼)</button>
            <button id="shareButton" class="control-button">ğŸ”— ê³µìœ í•˜ê¸°</button>
            <button id="clearButton" class="control-button">â†º ì´ˆê¸°í™”</button>
        </div>
    </div>

    <script>
        // ===========================================
        // â˜…â˜…â˜… JavaScript ì½”ë“œ ì˜ì—­ â˜…â˜…â˜…
        // ===========================================
        let audioContext;
        const MULTIPLIER = 1000;
        let isDroppedInMeasure = false; 

        // ---------------------------------------------
        // â˜…â˜…â˜… UTF-8 ì•ˆì „ ì¸ì½”ë”©/ë””ì½”ë”© í•¨ìˆ˜ (InvalidCharacterError í•´ê²° í•µì‹¬) â˜…â˜…â˜…
        // ---------------------------------------------
        function b64EncodeUnicode(str) {
            // 1. ë¬¸ìì—´ì„ UTF-8ë¡œ ì¸ì½”ë”©
            const utf8Str = encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, 
                function(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }
            );
            // 2. Base64ë¡œ ì¸ì½”ë”© (Latin1 ë²”ìœ„ ë‚´ì˜ ë¬¸ìì—´ë¡œ ë³€í™˜)
            return btoa(utf8Str);
        }

        function b64DecodeUnicode(str) {
            // 1. Base64 ë””ì½”ë”©
            const b64DecodedStr = atob(str);
            // 2. UTF-8 ë””ì½”ë”©
            try {
                return decodeURIComponent(b64DecodedStr.split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
            } catch(e) {
                console.error("UTF-8 ë””ì½”ë”© ì‹¤íŒ¨:", e);
                return "";
            }
        }
        
        // ---------------------------------------------
        // â˜…â˜…â˜… ê³µìœ  ê¸°ëŠ¥ ê´€ë ¨ í•¨ìˆ˜ â˜…â˜…â˜…
        // ---------------------------------------------
        /**
         * í˜„ì¬ ë¦¬ë“¬ ìƒíƒœë¥¼ ì¸ì½”ë”©ëœ ë¬¸ìì—´ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
         */
        function encodeRhythm() {
            const measures = document.querySelectorAll('.measure');
            const rhythmData = [];
            
            measures.forEach(measure => {
                const measureData = [];
                measure.querySelectorAll('.block').forEach(block => {
                    const duration = parseFloat(block.dataset.duration);
                    const type = block.dataset.type === 'note' ? 'n' : 'r'; 
                    // í…ìŠ¤íŠ¸ì— ì‰¼í‘œ(,), ì½œë¡ (:), ì„¸ë¯¸ì½œë¡ (;)ì´ í¬í•¨ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, 
                    // Base64 ì¸ì½”ë”© ì „ì— í…ìŠ¤íŠ¸ ìì²´ëŠ” URI ì¸ì½”ë”©í•˜ì§€ ì•Šê³  ì›ë³¸ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
                    const text = block.textContent; 
                    const widthClass = getWidthClass(duration);
                    
                    // ë°ì´í„° í¬ë§·: duration:type:text:widthClass
                    measureData.push(`${duration}:${type}:${text}:${widthClass}`);
                });
                rhythmData.push(measureData.join(','));
            });
            
            const timeSig = document.getElementById('timeSignature').value;
            const measureCount = document.getElementById('measureCount').value;

            // ìµœì¢… ë°ì´í„° í¬ë§·: timeSig|measureCount|measure1_data;measure2_data
            const rawData = `${timeSig}|${measureCount}|${rhythmData.join(';')}`;
            
            // UTF-8 ì•ˆì „ ì¸ì½”ë”© í•¨ìˆ˜ ì‚¬ìš©
            return b64EncodeUnicode(rawData);
        }

        /**
         * ì¸ì½”ë”©ëœ ë¬¸ìì—´ì„ í•´ë…í•˜ì—¬ ë¦¬ë“¬ì„ ì¬ìƒì„±í•©ë‹ˆë‹¤.
         */
        function decodeRhythm(encodedData, createBlockElement, updateMeasureStatus, handleDragOver, handleDragLeave, handleMeasureDrop, updateWholeNoteSettings) {
            const rhythmArea = document.getElementById('rhythmCreationArea');
            try {
                const rawData = b64DecodeUnicode(encodedData); 
                const parts = rawData.split('|');
                if (parts.length !== 3) return false;
                
                const [timeSig, measureCount, rhythmStrings] = parts;
                
                const timeSigSel = document.getElementById('timeSignature');
                const measureCntSel = document.getElementById('measureCount');
                
                // ë°•ì ë° ë§ˆë”” ìˆ˜ ì„¤ì •
                if (timeSigSel.querySelector(`option[value="${timeSig}"]`)) timeSigSel.value = timeSig;
                if (measureCntSel.querySelector(`option[value="${measureCount}"]`)) measureCntSel.value = measureCount;
                
                updateWholeNoteSettings();
                
                rhythmArea.innerHTML = '';
                
                const measureRhythms = rhythmStrings.split(';');

                const currentMeasureCount = parseInt(measureCntSel.value);
                const targetMeasureCount = Math.max(measureRhythms.length, currentMeasureCount);
                
                for (let i = 0; i < targetMeasureCount; i++) {
                    const measure = document.createElement('div');
                    measure.className = 'measure';
                    measure.dataset.id = i;
                    
                    measure.addEventListener('dragover', handleDragOver);
                    measure.addEventListener('dragleave', handleDragLeave);
                    measure.addEventListener('drop', handleMeasureDrop);

                    const info = document.createElement('div');
                    info.className = 'measure-info';
                    measure.appendChild(info);
                    rhythmArea.appendChild(measure);

                    if (i < measureRhythms.length) {
                         const blocks = measureRhythms[i].split(',');
                         blocks.forEach(blockStr => {
                             if (blockStr) {
                                 const parts = blockStr.split(':');
                                 // duration:type:text:widthClass
                                 if(parts.length < 4) return;
                                 
                                 const [duration, typeCode, text, widthClass] = parts;
                                 const data = {
                                     duration: duration,
                                     type: typeCode === 'n' ? 'note' : 'rest',
                                     label: '', 
                                     text: text, // ìŒì•… ê¸°í˜¸ í…ìŠ¤íŠ¸
                                 };
                                 const el = createBlockElement(data);
                                 // widthClassëŠ” ì¸ì½”ë”© ë°ì´í„°ì— í¬í•¨ë˜ì–´ ìˆì§€ë§Œ, createBlockElement ë‚´ë¶€ì—ì„œ ë‹¤ì‹œ ê³„ì‚°ë˜ë¯€ë¡œ 
                                 // ì—¬ê¸°ì„œëŠ” ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •ëœ ë°ì´í„°ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
                                 // el.className = `block ${data.type === 'note' ? 'note-block' : 'rest-block'} ${widthClass}`; // createBlockElementì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨
                                 measure.appendChild(el);
                             }
                         });
                    }
                    updateMeasureStatus(measure); 
                }
                
                return true;
            } catch (e) {
                console.error("Rhythm decoding error:", e);
                return false;
            }
        }

        // ---------------------------------------------
        // â˜…â˜…â˜… ê¸°ë³¸ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ë³€ê²½ ì—†ìŒ) â˜…â˜…â˜…
        // ---------------------------------------------
        function getTempo() {
            return parseInt(document.getElementById('tempoSelect').value);
        }

        function toInt(beat) {
            return Math.round(parseFloat(beat) * MULTIPLIER);
        }
        function toBeat(intVal) {
            return intVal / MULTIPLIER;
        }

        function getWidthClass(duration) {
            if(duration == 4) return 'w4';
            if(duration == 3) return 'w3';
            if(duration == 2) return 'w2';
            if(duration == 1.5) return 'w1_5';
            if(duration == 1) return 'w1';
            if(duration == 0.75) return 'w0_75';
            if(duration == 0.5) return 'w0_5';
            if(duration == 0.375) return 'w0_375';
            if(duration == 0.25) return 'w0_25';
            return 'w1'; 
        }

        // ===========================================
        // â˜…â˜…â˜… DOMContentLoaded ì˜ì—­ (ì´ë²¤íŠ¸ ë° ë³´ì¡° í•¨ìˆ˜) â˜…â˜…â˜…
        // ===========================================
        document.addEventListener('DOMContentLoaded', () => {
            // ë³€ìˆ˜ ì •ì˜
            const rhythmArea = document.getElementById('rhythmCreationArea');
            const statusMsg = document.getElementById('statusMessage');
            const timeSigSel = document.getElementById('timeSignature');
            const measureCntSel = document.getElementById('measureCount');
            const tempoSel = document.getElementById('tempoSelect'); 
            
            const wholeNoteBlock = document.getElementById('wholeNote');
            const wholeRestBlock = document.getElementById('wholeRest');
            
            const shareLinkArea = document.getElementById('shareLinkArea');
            const shareLinkInput = document.getElementById('shareLinkInput');
            const shareButton = document.getElementById('shareButton'); 
            
            let draggedItem = null;
            let sourceMeasure = null;
            
            // --- ë³´ì¡° í•¨ìˆ˜ ì •ì˜ ---
            function updateWholeNoteSettings() {
                const beats = getBeatsPerMeasureInt() / MULTIPLIER; 
                
                wholeNoteBlock.dataset.duration = beats;
                wholeRestBlock.dataset.duration = beats;

                const classes = ['w4', 'w3', 'w2', 'w1', 'w1_5', 'w0_75', 'w0_5', 'w0_25', 'w0_375'];
                wholeNoteBlock.classList.remove(...classes);
                wholeRestBlock.classList.remove(...classes);

                const newClass = getWidthClass(beats); 
                wholeNoteBlock.classList.add(newClass);
                wholeRestBlock.classList.add(newClass);
            }
            
            function generateMeasures() {
                rhythmArea.innerHTML = '';
                const count = parseInt(measureCntSel.value);
                
                for(let i=0; i<count; i++) {
                    const measure = document.createElement('div');
                    measure.className = 'measure';
                    measure.dataset.id = i;
                    
                    measure.addEventListener('dragover', handleDragOver);
                    measure.addEventListener('dragleave', handleDragLeave);
                    measure.addEventListener('drop', handleMeasureDrop);
                    
                    const info = document.createElement('div');
                    info.className = 'measure-info';
                    measure.appendChild(info);

                    rhythmArea.appendChild(measure);
                    updateMeasureStatus(measure);
                }
            }

            function getBeatsPerMeasureInt() {
                return toInt(timeSigSel.value.split('/')[0]);
            }

            function getMeasureTotalInt(measure) {
                let total = 0;
                measure.querySelectorAll('.block').forEach(b => {
                    total += toInt(b.dataset.duration);
                });
                return total;
            }

            function updateMeasureStatus(measure) {
                const max = getBeatsPerMeasureInt(); 
                const current = getMeasureTotalInt(measure);
                const remaining = max - current;
                
                const info = measure.querySelector('.measure-info');

                measure.classList.remove('overflow');
                measure.style.backgroundColor = '#fff';
                measure.style.borderColor = '#adb5bd';
                info.style.color = '#6c757d';

                if (current > max) {
                    measure.classList.add('overflow');
                    measure.style.backgroundColor = '#fff5f5';
                    measure.style.borderColor = '#fa5252';
                    info.textContent = `âŒ ${toBeat(Math.abs(remaining))}ë°• ì´ˆê³¼`;
                    info.style.color = '#fa5252';
                } else if (current === max) {
                    measure.style.backgroundColor = '#ebfbee'; 
                    measure.style.borderColor = '#40c057';
                    info.textContent = `âœ… ${toBeat(max)}ë°• ì™„ì„±`;
                    info.style.color = '#2f9e44';
                } else {
                    info.textContent = `${toBeat(remaining)}ë°• ë‚¨ìŒ`;
                }
            }

            // --- Drag & Drop í•¸ë“¤ëŸ¬ ---
            function handleDragStart(e) {
                draggedItem = this;
                sourceMeasure = this.closest('.measure');
                
                const data = {
                    type: this.dataset.type,
                    duration: this.dataset.duration,
                    label: this.dataset.label,
                    text: this.textContent,
                };
                
                e.dataTransfer.setData('text/plain', JSON.stringify(data));
                e.dataTransfer.effectAllowed = 'copyMove';
                setTimeout(() => this.classList.add('dragging'), 0);
            }

            function handleDragEnd(e) {
                this.classList.remove('dragging');
                document.querySelectorAll('.measure').forEach(m => m.classList.remove('drag-over'));
                
                if (sourceMeasure && draggedItem && !isDroppedInMeasure && sourceMeasure.contains(draggedItem)) {
                     draggedItem.remove();
                     updateMeasureStatus(sourceMeasure);
                     statusMsg.textContent = 'ğŸ—‘ï¸ï¸ ë¸”ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
                     setTimeout(() => statusMsg.textContent = '', 1500);
                }
                
                draggedItem = null;
                sourceMeasure = null;
                isDroppedInMeasure = false; 
            }

            function handleDragOver(e) {
                e.preventDefault(); 
                this.classList.add('drag-over');
            }

            function handleDragLeave(e) {
                this.classList.remove('drag-over');
            }

            function handleMeasureDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('drag-over');
                
                isDroppedInMeasure = true; 

                let data;
                try { data = JSON.parse(e.dataTransfer.getData('text/plain')); } catch(err) { return; }
                
                const newDurInt = toInt(data.duration);
                const currentTotalInt = getMeasureTotalInt(this);
                const maxInt = getBeatsPerMeasureInt();

                if (draggedItem && sourceMeasure === this) {
                    insertBlock(this, draggedItem, e.clientX);
                    updateMeasureStatus(this);
                    return;
                }

                if (currentTotalInt + newDurInt > maxInt) {
                    statusMsg.textContent = `âš ï¸ ê³µê°„ ë¶€ì¡±!`;
                    setTimeout(() => statusMsg.textContent = '', 2000);
                    return;
                }

                let blockToInsert;
                if (draggedItem && sourceMeasure) {
                    blockToInsert = draggedItem;
                } else {
                    blockToInsert = createBlockElement(data);
                }

                insertBlock(this, blockToInsert, e.clientX);
                updateMeasureStatus(this);
                if (sourceMeasure && sourceMeasure !== this) {
                    updateMeasureStatus(sourceMeasure);
                    if(draggedItem && sourceMeasure.className.includes('measure')) {
                         draggedItem.remove();
                    }
                }
            }

            function insertBlock(measure, block, clientX) {
                const siblings = [...measure.querySelectorAll('.block:not(.dragging)')];
                const nextSibling = siblings.find(sibling => {
                    const box = sibling.getBoundingClientRect();
                    return clientX < box.left + box.width / 2;
                });
                
                if (nextSibling) measure.insertBefore(block, nextSibling);
                else measure.appendChild(block);
            }

            function createBlockElement(data) {
                const el = document.createElement('div');
                let typeClass = data.type === 'note' ? 'note-block' : 'rest-block';
                let widthClass = getWidthClass(parseFloat(data.duration));
                
                el.className = `block ${typeClass} ${widthClass}`;
                el.draggable = true;
                el.dataset.type = data.type;
                el.dataset.duration = data.duration;
                el.dataset.label = data.label;
                el.textContent = data.text;

                el.addEventListener('dragstart', handleDragStart);
                el.addEventListener('dragend', handleDragEnd);
                return el;
            }
            
            // --- ì´ˆê¸°í™” ë° URL ë³µì› ë¡œì§ ---
            function init() {
                // URL ë³µì› ë¡œì§
                const urlParams = new URLSearchParams(window.location.search);
                const encodedRhythm = urlParams.get('rhythm');
                
                if (encodedRhythm) {
                    if (decodeRhythm(encodedRhythm, createBlockElement, updateMeasureStatus, handleDragOver, handleDragLeave, handleMeasureDrop, updateWholeNoteSettings)) {
                        statusMsg.textContent = 'ğŸ‰ ê³µìœ ëœ ë¦¬ë“¬ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!';
                    } else {
                        statusMsg.textContent = 'âŒ ê³µìœ ëœ ë¦¬ë“¬ ë°ì´í„°ê°€ ì†ìƒë˜ì—ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ ë§ˆë””ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.';
                        generateMeasures(); 
                    }
                } else {
                    generateMeasures();
                }
                
                updateWholeNoteSettings(); 
                
                const allBlocks = document.querySelectorAll('.block');
                allBlocks.forEach(block => {
                    // ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ë‹¤ì‹œ ë¶€ì°©
                    block.removeEventListener('dragstart', handleDragStart);
                    block.removeEventListener('dragend', handleDragEnd);
                    block.addEventListener('dragstart', handleDragStart);
                    block.addEventListener('dragend', handleDragEnd);
                });

                document.addEventListener('dragover', (e) => e.preventDefault());
                
                shareLinkArea.classList.remove('active');
            }

            // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
            timeSigSel.addEventListener('change', () => {
                updateWholeNoteSettings();
                generateMeasures();
            });

            measureCntSel.addEventListener('change', generateMeasures);
            document.getElementById('clearButton').addEventListener('click', generateMeasures);

            tempoSel.addEventListener('change', () => {
                const selectedOption = tempoSel.options[tempoSel.selectedIndex];
                const tempoLabel = selectedOption.dataset.label;
                statusMsg.textContent = `ğŸµ ë¹ ë¥´ê¸°ê°€ "${tempoLabel}" (${getTempo()} BPM)ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                setTimeout(() => statusMsg.textContent = '', 3000);
            });
            
            // --- ê³µìœ  ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
            shareButton.addEventListener('click', () => {
                const encoded = encodeRhythm(); 
                let shareUrl;

                // 1. í˜„ì¬ íŒŒì¼ì˜ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸° (ë¡œì»¬ íŒŒì¼ ì‹¤í–‰ ì‹œ ê²½ë¡œê°€ file:/// ë¡œ ì‹œì‘)
                try {
                    const baseUrl = window.location.href.split('?')[0].split('#')[0];
                    shareUrl = `${baseUrl}?rhythm=${encoded}`;
                } catch (e) {
                    // ì˜ˆì™¸ ë°œìƒ ì‹œ (ë§¤ìš° ì•ˆì „í•œ ë¡œì»¬ í™˜ê²½), ì„ì‹œ ë©”ì‹œì§€ ì‚¬ìš©
                    shareUrl = `https://blog.naver.com/parosaone/221730713052?rhythm=${encoded}`;
                }

                shareLinkInput.value = shareUrl;

                shareLinkArea.classList.add('active');
                
                // í…ìŠ¤íŠ¸ ì„ íƒ ë° í¬ì»¤ìŠ¤
                setTimeout(() => {
                    if (shareLinkInput) {
                        shareLinkInput.select(); 
                        shareLinkInput.focus(); 
                    }
                }, 50); 

                // í´ë¦½ë³´ë“œ ìë™ ë³µì‚¬ ì‹œë„
                try {
                    if (navigator.clipboard) {
                         navigator.clipboard.writeText(shareUrl).then(() => {
                            statusMsg.textContent = `âœ… ë§í¬ê°€ í´ë¦½ë³´ë“œì— **ìë™ ë³µì‚¬**ë˜ì—ˆìŠµë‹ˆë‹¤! (ìƒˆ ì°½ì—ì„œ ì—´ì–´ ë³µì› í™•ì¸)`;
                         }).catch(() => {
                             statusMsg.textContent = `ğŸ“¢ **ìë™ ë³µì‚¬ ì‹¤íŒ¨.** ìœ„ì˜ ë§í¬ í•„ë“œë¥¼ **ì „ì²´ ë³µì‚¬(Ctrl+A í›„ Ctrl+C)**í•˜ì—¬ ê³µìœ í•˜ì‹­ì‹œì˜¤.`;
                         });
                    } else if (document.execCommand('copy')) { // êµ¬í˜• ë¸Œë¼ìš°ì € ì§€ì›
                         statusMsg.textContent = `âœ… ë§í¬ê°€ í´ë¦½ë³´ë“œì— **ìë™ ë³µì‚¬**ë˜ì—ˆìŠµë‹ˆë‹¤!`;
                    } else {
                         statusMsg.textContent = `ğŸ“¢ **ìë™ ë³µì‚¬ ì‹¤íŒ¨.** ìœ„ì˜ ë§í¬ í•„ë“œë¥¼ **ì „ì²´ ë³µì‚¬(Ctrl+A í›„ Ctrl+C)**í•˜ì—¬ ê³µìœ í•˜ì‹­ì‹œì˜¤.`;
                    }
                } catch (err) {
                    statusMsg.textContent = `ğŸ“¢ **ìë™ ë³µì‚¬ ì‹¤íŒ¨.** ìœ„ì˜ ë§í¬ í•„ë“œë¥¼ **ì „ì²´ ë³µì‚¬(Ctrl+A í›„ Ctrl+C)**í•˜ì—¬ ê³µìœ í•˜ì‹­ì‹œì˜¤.`;
                }
            });

            // --- ì¬ìƒ ë¡œì§ ---
            document.getElementById('playButton').addEventListener('click', async () => {
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') await audioContext.resume();

                const blocks = document.querySelectorAll('.measure .block');
                if (blocks.length === 0) return alert('ì¬ìƒí•  ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');

                const currentTempo = getTempo();
                const secondsPerBeat = 60 / currentTempo; 

                let currentTime = audioContext.currentTime + 0.1;
                const measures = document.querySelectorAll('.measure');
                
                document.querySelectorAll('.block.playing').forEach(b => b.classList.remove('playing'));

                measures.forEach(measure => {
                    measure.querySelectorAll('.block').forEach(block => {
                        const duration = parseFloat(block.dataset.duration) * secondsPerBeat; 
                        
                        const start = currentTime;
                        const end = currentTime + duration;

                        setTimeout(() => block.classList.add('playing'), (start - audioContext.currentTime) * 1000);
                        setTimeout(() => block.classList.remove('playing'), (end - audioContext.currentTime) * 1000);

                        if (block.dataset.type === 'note') {
                            playDrumSound(start, secondsPerBeat);
                        }
                        currentTime += duration;
                    });
                });
            });

            function playDrumSound(time, secondsPerBeat) {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                
                const decayTime = secondsPerBeat * 0.5;

                // ë“œëŸ¼/í¼ì»¤ì…˜ ì†Œë¦¬ë¥¼ ìœ„í•´ ì£¼íŒŒìˆ˜ë¥¼ ë‚®ê²Œ ì„¤ì •í•˜ê³  ë¹ ë¥´ê²Œ ê°ì‡ ì‹œí‚µë‹ˆë‹¤.
                osc.frequency.setValueAtTime(150, time);
                osc.frequency.exponentialRampToValueAtTime(0.01, time + decayTime);
                
                gain.gain.setValueAtTime(5, time); 
                gain.gain.exponentialRampToValueAtTime(0.01, time + decayTime);

                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.start(time);
                osc.stop(time + decayTime);
            }

            // ìµœì¢… ì´ˆê¸°í™”
            init();
        });
    </script>
</body>
</html>